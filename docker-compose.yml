version: '3.8'

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped

    ports:
      - "6333:6333"  # REST API + Dashboard
      - "6334:6334"  # gRPC API

    volumes:
      - /home/administrator/projects/data/qdrant:/qdrant/storage

    networks:
      - qdrant-net
      - loki-net

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    healthcheck:
      test: ["CMD-SHELL", "timeout 10s bash -c ':> /dev/tcp/127.0.0.1/6333' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    environment:
      # Qdrant configuration
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334

    labels:
      - "com.docker.compose.project=qdrant"
      - "description=Qdrant vector database - centralized infrastructure"
      - "purpose=vector-storage"

  # OAuth2 Proxy (authentication gateway)
  qdrant-auth-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    container_name: qdrant-auth-proxy
    restart: unless-stopped

    env_file:
      - $HOME/projects/secrets/qdrant-oauth2.env

    networks:
      - traefik-net
      - keycloak-net
      - qdrant-net

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-net"
      - "traefik.http.routers.qdrant.rule=Host(`qdrant.ai-servicers.com`)"
      - "traefik.http.routers.qdrant.entrypoints=websecure"
      - "traefik.http.routers.qdrant.tls=true"
      - "traefik.http.routers.qdrant.tls.certresolver=letsencrypt"
      - "traefik.http.services.qdrant.loadbalancer.server.port=4180"

    depends_on:
      - qdrant

networks:
  qdrant-net:
    external: true
  loki-net:
    external: true
  traefik-net:
    external: true
  keycloak-net:
    external: true
